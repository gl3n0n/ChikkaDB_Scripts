select count(duration) from ( 
   select duration, count(1)
   from ( select phone, greatest(round(((unmap_ts-map_ts)/1000)/60,0),0) duration
          from   powerapp_mapping_usage
          where  datein ='2014-03-11'
        ) x
   group by duration
) y;

drop procedure if exists sp_generate_hi10_percentile;
delimiter //
create procedure sp_generate_hi10_percentile (p_percentile int, p_date date)
begin
   -- get percentile
   -- FORMULA: (P/100) * N + (1/2) 
   -- (Total number of ordered list, number of durations)

   select round((p_percentile/100) * count(duration) + (1/2),0), count(duration), max(duration), avg(duration)
   into    @N, @T, @MaxD, @AvgD
   from (select duration, count(1)
         from ( select phone, greatest(round(((unmap_ts-map_ts)/1000)/60,0),0) duration
                from   powerapp_mapping_usage
                where  datein = p_date
                and    unmap_ts is not null
                and    unmap_ts > map_ts
              ) x
         group by duration
   ) y;

   select p_date Date, concat('FORMULA: ROUND((', p_percentile, '/100) * ', @T, ' + (1/2),0) = ', @N) formula, @AvgD AvgDuration, @MaxD MaxDuration; 

   select rank, duration, no_subs from (
      -- rank duration based on most subs
      select duration, no_subs, 
             @curRank := @curRank + 1 AS rank
      from (  
         -- get number of subs per duration
         select duration, 
                count(1) no_subs
         from ( select phone, greatest(round(((unmap_ts-map_ts)/1000)/60,0),0) duration
                from   powerapp_mapping_usage
                where  datein = p_date
                and    unmap_ts is not null
                and    unmap_ts > map_ts
              ) x
         group by duration
         order by 2
      ) y, (SELECT @curRank := 0) rnk
   ) z 
   where rank > @N
   order by rank desc;
end;
//
delimiter ;

##########################################################################

drop procedure if exists sp_generate_hi10_percentile;
delimiter //
create procedure sp_generate_hi10_percentile (p_percentile int, p_date date)
begin
   -- get percentile
   -- FORMULA: (P/100) * N + (1/2) 
   -- (Total number of ordered list, number of durations)

   select round((p_percentile/100) * count(duration) + (1/2),0), count(duration), max(duration), avg(duration)
   into    @N, @T, @MaxD, @AvgD
   from (select duration, count(1)
         from ( select phone, sum(greatest(round(((unmap_ts-map_ts)/1000)/60,0),0)) duration
                from   powerapp_mapping_usage
                where  datein = p_date
                and    unmap_ts is not null
                and    unmap_ts > map_ts
                group by phone
              ) x
         group by duration
   ) y;

   select p_date Date, concat('FORMULA: ROUND((', p_percentile, '/100) * ', @T, ' + (1/2),0) = ', @N) Formula, @AvgD AvgDuration, @MaxD MaxDuration; 

   select rank, duration, no_subs from (
      -- rank duration based on most subs
      select duration, no_subs, 
             @curRank := @curRank + 1 AS rank
      from (  
         -- get number of subs per duration
         select duration, 
                count(1) no_subs
         from ( select phone, sum(greatest(round(((unmap_ts-map_ts)/1000)/60,0),0)) duration
                from   powerapp_mapping_usage
                where  datein = p_date
                and    unmap_ts is not null
                and    unmap_ts > map_ts
                group by phone
              ) x
         group by duration
         order by 1
      ) y, (SELECT @curRank := 0) rnk
   ) z 
   where rank >= @N
   order by rank desc;
end;
//
delimiter ;

call sp_generate_hi10_percentile(90, '2014-03-11');


Order is in Number of Subs
+------------+--------------------------------------------------+---------------+-------------+
| Date       | formula                                          | AvgDuration   | MaxDuration |
+------------+--------------------------------------------------+---------------+-------------+
| 2014-03-11 | FORMULA: ROUND((90/100) * 1508 + (1/2),0) = 1358 | 883.844164456 |        6467 |
+------------+--------------------------------------------------+---------------+-------------+
1 row in set (33.00 sec)

+------+----------+---------+
| rank | duration | no_subs |
+------+----------+---------+
| 1508 |        0 |    3023 |
| 1507 |        1 |    2073 |
| 1506 |        2 |    1291 |
| 1505 |        3 |    1067 |
| 1504 |        4 |     947 |
| 1503 |        6 |     803 |
| 1502 |        5 |     800 |
| 1501 |        7 |     680 |
| 1500 |        8 |     578 |
| 1499 |        9 |     576 |
| 1498 |       10 |     533 |
| 1497 |       11 |     505 |
| 1496 |       12 |     455 |
| 1495 |       14 |     445 |
| 1494 |       13 |     441 |
| 1493 |       15 |     405 |
| 1492 |       17 |     383 |
| 1491 |       16 |     380 |
| 1490 |       20 |     378 |
| 1489 |       18 |     372 |
| 1488 |       19 |     365 |
| 1487 |       25 |     351 |
| 1486 |       21 |     341 |
| 1485 |       22 |     338 |
| 1484 |       26 |     322 |
| 1483 |       24 |     307 |
| 1482 |       27 |     306 |
| 1481 |       23 |     300 |
| 1480 |       28 |     297 |
| 1479 |       30 |     286 |
| 1478 |       34 |     284 |
| 1477 |       33 |     272 |
| 1476 |       40 |     268 |
| 1475 |       31 |     263 |
| 1474 |       37 |     262 |
| 1473 |       32 |     253 |
| 1472 |       36 |     247 |
| 1471 |       35 |     246 |
| 1470 |       29 |     235 |
| 1469 |       62 |     230 |
| 1468 |       51 |     228 |
| 1467 |       42 |     228 |
| 1466 |       38 |     226 |
| 1465 |       43 |     225 |
| 1464 |       45 |     223 |
| 1463 |       47 |     223 |
| 1462 |       44 |     221 |
| 1461 |       61 |     221 |
| 1460 |       39 |     216 |
| 1459 |       60 |     210 |
| 1458 |       58 |     205 |
| 1457 |       41 |     205 |
| 1456 |       53 |     204 |
| 1455 |       46 |     200 |
| 1454 |       55 |     199 |
| 1453 |       48 |     196 |
| 1452 |       57 |     195 |
| 1451 |       49 |     191 |
| 1450 |       67 |     184 |
| 1449 |       56 |     183 |
| 1448 |       64 |     182 |
| 1447 |       65 |     178 |
| 1446 |       52 |     177 |
| 1445 |       54 |     176 |
| 1444 |       63 |     175 |
| 1443 |       59 |     175 |
| 1442 |       72 |     174 |
| 1441 |       68 |     174 |
| 1440 |       66 |     170 |
| 1439 |       69 |     168 |
| 1438 |       74 |     168 |
| 1437 |       70 |     166 |
| 1436 |       50 |     165 |
| 1435 |       76 |     162 |
| 1434 |       88 |     158 |
| 1433 |       73 |     152 |
| 1432 |       77 |     150 |
| 1431 |       93 |     144 |
| 1430 |       92 |     144 |
| 1429 |       71 |     144 |
| 1428 |       89 |     144 |
| 1427 |       78 |     143 |
| 1426 |      119 |     141 |
| 1425 |       80 |     140 |
| 1424 |       86 |     139 |
| 1423 |       79 |     138 |
| 1422 |       87 |     137 |
| 1421 |       82 |     137 |
| 1420 |       85 |     136 |
| 1419 |       75 |     134 |
| 1418 |       81 |     133 |
| 1417 |       91 |     133 |
| 1416 |       94 |     130 |
| 1415 |       96 |     129 |
| 1414 |      105 |     128 |
| 1413 |      126 |     127 |
| 1412 |      120 |     126 |
| 1411 |       90 |     125 |
| 1410 |      115 |     125 |
| 1409 |       97 |     123 |
| 1408 |      103 |     122 |
| 1407 |      100 |     120 |
| 1406 |      130 |     119 |
| 1405 |      102 |     118 |
| 1404 |       84 |     118 |
| 1403 |      124 |     117 |
| 1402 |      134 |     116 |
| 1401 |       83 |     114 |
| 1400 |      106 |     113 |
| 1399 |      101 |     113 |
| 1398 |       95 |     113 |
| 1397 |      109 |     113 |
| 1396 |      108 |     112 |
| 1395 |      128 |     110 |
| 1394 |      116 |     109 |
| 1393 |      125 |     108 |
| 1392 |      107 |     108 |
| 1391 |       98 |     107 |
| 1390 |       99 |     104 |
| 1389 |      136 |     103 |
| 1388 |      118 |     103 |
| 1387 |      123 |     102 |
| 1386 |      148 |     101 |
| 1385 |      122 |     101 |
| 1384 |      139 |     100 |
| 1383 |      129 |     100 |
| 1382 |      112 |      99 |
| 1381 |      135 |      98 |
| 1380 |      156 |      98 |
| 1379 |      127 |      98 |
| 1378 |      104 |      97 |
| 1377 |      117 |      97 |
| 1376 |      147 |      96 |
| 1375 |      149 |      96 |
| 1374 |      121 |      96 |
| 1373 |      141 |      96 |
| 1372 |      146 |      94 |
| 1371 |      110 |      94 |
| 1370 |      111 |      93 |
| 1369 |      113 |      93 |
| 1368 |      142 |      91 |
| 1367 |      133 |      90 |
| 1366 |      163 |      88 |
| 1365 |      151 |      88 |
| 1364 |      160 |      88 |
| 1363 |      162 |      88 |
| 1362 |      144 |      88 |
| 1361 |      159 |      88 |
| 1360 |      165 |      88 |
| 1359 |      140 |      88 |
+------+----------+---------+
150 rows in set (1 min 5.88 sec)



Order is in Duration
+------------+--------------------------------------------------+---------------+-------------+
| Date       | Formula                                          | AvgDuration   | MaxDuration |
+------------+--------------------------------------------------+---------------+-------------+
| 2014-03-11 | FORMULA: ROUND((90/100) * 1508 + (1/2),0) = 1358 | 883.844164456 |        6467 |
+------------+--------------------------------------------------+---------------+-------------+
1 row in set (33.30 sec)

+------+----------+---------+
| rank | duration | no_subs |
+------+----------+---------+
| 1508 |     6467 |       1 |
| 1507 |     6419 |       1 |
| 1506 |     6144 |       1 |
| 1505 |     5880 |       1 |
| 1504 |     5652 |       1 |
| 1503 |     4114 |       1 |
| 1502 |     4089 |       1 |
| 1501 |     4036 |       1 |
| 1500 |     3940 |       1 |
| 1499 |     3887 |       1 |
| 1498 |     3819 |       1 |
| 1497 |     3759 |       1 |
| 1496 |     3685 |       1 |
| 1495 |     3680 |       1 |
| 1494 |     3619 |       1 |
| 1493 |     3564 |       1 |
| 1492 |     3558 |       1 |
| 1491 |     3486 |       1 |
| 1490 |     3415 |       2 |
| 1489 |     3411 |       1 |
| 1488 |     3395 |       1 |
| 1487 |     3355 |       1 |
| 1486 |     3184 |       1 |
| 1485 |     3147 |       1 |
| 1484 |     2902 |       1 |
| 1483 |     2900 |       1 |
| 1482 |     2888 |       1 |
| 1481 |     2886 |       1 |
| 1480 |     2875 |       1 |
| 1479 |     2854 |       1 |
| 1478 |     2821 |       1 |
| 1477 |     2804 |       1 |
| 1476 |     2802 |       1 |
| 1475 |     2747 |       1 |
| 1474 |     2736 |       1 |
| 1473 |     2735 |       1 |
| 1472 |     2573 |       1 |
| 1471 |     2563 |       1 |
| 1470 |     2555 |       1 |
| 1469 |     2552 |       1 |
| 1468 |     2531 |       1 |
| 1467 |     2525 |       1 |
| 1466 |     2483 |       1 |
| 1465 |     2442 |       1 |
| 1464 |     2432 |       1 |
| 1463 |     2408 |       2 |
| 1462 |     2400 |       1 |
| 1461 |     2397 |       1 |
| 1460 |     2385 |       1 |
| 1459 |     2356 |       1 |
| 1458 |     2344 |       1 |
| 1457 |     2341 |       2 |
| 1456 |     2338 |       1 |
| 1455 |     2333 |       1 |
| 1454 |     2328 |       1 |
| 1453 |     2322 |       1 |
| 1452 |     2315 |       1 |
| 1451 |     2314 |       1 |
| 1450 |     2304 |       1 |
| 1449 |     2300 |       1 |
| 1448 |     2299 |       1 |
| 1447 |     2264 |       1 |
| 1446 |     2256 |       1 |
| 1445 |     2246 |       1 |
| 1444 |     2222 |       1 |
| 1443 |     2217 |       1 |
| 1442 |     2215 |       1 |
| 1441 |     2210 |       1 |
| 1440 |     2209 |       2 |
| 1439 |     2206 |       1 |
| 1438 |     2200 |       1 |
| 1437 |     2197 |       1 |
| 1436 |     2195 |       1 |
| 1435 |     2191 |       1 |
| 1434 |     2173 |       1 |
| 1433 |     2169 |       1 |
| 1432 |     2162 |       1 |
| 1431 |     2161 |       1 |
| 1430 |     2153 |       1 |
| 1429 |     2147 |       1 |
| 1428 |     2143 |       1 |
| 1427 |     2135 |       1 |
| 1426 |     2126 |       1 |
| 1425 |     2118 |       1 |
| 1424 |     2108 |       1 |
| 1423 |     2106 |       2 |
| 1422 |     2105 |       1 |
| 1421 |     2103 |       1 |
| 1420 |     2102 |       1 |
| 1419 |     2096 |       1 |
| 1418 |     2090 |       1 |
| 1417 |     2074 |       1 |
| 1416 |     2067 |       2 |
| 1415 |     2063 |       1 |
| 1414 |     2056 |       1 |
| 1413 |     2051 |       1 |
| 1412 |     2047 |       1 |
| 1411 |     2040 |       1 |
| 1410 |     2034 |       1 |
| 1409 |     2025 |       2 |
| 1408 |     2021 |       1 |
| 1407 |     2019 |       1 |
| 1406 |     2017 |       1 |
| 1405 |     2016 |       1 |
| 1404 |     2014 |       1 |
| 1403 |     2013 |       1 |
| 1402 |     2010 |       1 |
| 1401 |     2001 |       1 |
| 1400 |     1995 |       1 |
| 1399 |     1966 |       1 |
| 1398 |     1961 |       1 |
| 1397 |     1955 |       1 |
| 1396 |     1945 |       1 |
| 1395 |     1941 |       1 |
| 1394 |     1940 |       1 |
| 1393 |     1935 |       1 |
| 1392 |     1917 |       1 |
| 1391 |     1914 |       1 |
| 1390 |     1908 |       1 |
| 1389 |     1904 |       1 |
| 1388 |     1903 |       1 |
| 1387 |     1902 |       1 |
| 1386 |     1896 |       1 |
| 1385 |     1886 |       1 |
| 1384 |     1885 |       1 |
| 1383 |     1884 |       1 |
| 1382 |     1882 |       1 |
| 1381 |     1881 |       1 |
| 1380 |     1873 |       1 |
| 1379 |     1867 |       1 |
| 1378 |     1864 |       1 |
| 1377 |     1848 |       1 |
| 1376 |     1846 |       2 |
| 1375 |     1829 |       1 |
| 1374 |     1825 |       1 |
| 1373 |     1792 |       1 |
| 1372 |     1791 |       1 |
| 1371 |     1789 |       2 |
| 1370 |     1771 |       1 |
| 1369 |     1769 |       1 |
| 1368 |     1746 |       1 |
| 1367 |     1740 |       1 |
| 1366 |     1735 |       1 |
| 1365 |     1729 |       1 |
| 1364 |     1727 |       1 |
| 1363 |     1723 |       1 |
| 1362 |     1719 |       1 |
| 1361 |     1716 |       1 |
| 1360 |     1715 |       1 |
| 1359 |     1709 |       1 |
| 1358 |     1706 |       1 |
+------+----------+---------+
151 rows in set (1 min 5.88 sec)


select * 
from ( select phone, sum(greatest(round(((unmap_ts-map_ts)/1000)/60,0),0)) duration
       from   powerapp_mapping_usage
       where  datein = '2014-03-11'
       and    unmap_ts is not null
       and    unmap_ts > map_ts
       group by phone
     ) x  where duration = 6467;

select * from powerapp_mapping_usage where datein = '2014-03-11' and phone = '639305001930';
+--------------+-------------+--------------+------------+-------------------+---------------------+---------------+-------------------+---------------------+---------------+-------+
|   map_tx_id  | unmap_tx_id | phone        | datein     | map_ipadd         | map_datein          | map_ts        | unmap_ipadd       | unmap_datein        | unmap_ts      | brand |
+--------------+-------------+--------------+------------+-------------------+---------------------+---------------+-------------------+---------------------+---------------+-------+
|     47321866 |    47321876 | 639305001930 | 2014-03-11 | 10.162.252.150/32 | 2014-03-11 22:10:03 | 1394575803465 | 10.162.252.150/32 | 2014-03-11 22:10:04 | 1394575803966 | TNT   |
|     47321870 |    47321979 | 639305001930 | 2014-03-11 | 10.162.106.191/32 | 2014-03-11 22:10:03 | 1394575803465 | 10.162.106.191/32 | 2014-03-11 22:10:07 | 1394575807469 | TNT   |
|     47321981 |    47508060 | 639305001930 | 2014-03-11 | 10.162.211.59/32  | 2014-03-11 22:10:07 | 1394575807469 | 10.162.211.59/32  | 2014-03-11 23:35:30 | 1394580929891 | TNT   |
|     47508576 |    67093870 | 639305001930 | 2014-03-11 | 10.162.13.239/32  | 2014-03-11 23:35:43 | 1394580942949 | 10.162.13.239/32  | 2014-03-16 09:57:57 | 1394963876937 | TNT   |
+--------------+-------------+--------------+------------+-------------------+---------------------+---------------+-------------------+---------------------+---------------+-------+
4 rows in set (29.90 sec)
